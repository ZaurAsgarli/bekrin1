<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>≈ûagird Davamiyy…ôti - Bekrin School</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; padding: 20px 30px; border-radius: 15px; display: flex; align-items: center; gap: 20px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .back-btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; }
        .back-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
        .header h1 { color: #667eea; font-size: 24px; flex-grow: 1; }
        .loading { text-align: center; color: white; font-size: 18px; padding: 40px; }
        .attendance-card { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .progress-container { margin-bottom: 30px; }
        .progress-label { display: flex; justify-content: space-between; margin-bottom: 10px; color: #333; font-weight: 600; }
        .progress-bar { width: 100%; height: 30px; background: #f0f0f0; border-radius: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; border-radius: 10px; text-align: center; transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .stat-card.present { background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%); }
        .stat-card.late { background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); }
        .stat-card.absent { background: linear-gradient(135deg, #ff7675 0%, #d63031 100%); color: white; }
        .stat-card.excused { background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); color: white; }
        .stat-number { font-size: 32px; font-weight: 700; margin-bottom: 5px; }
        .stat-label { font-size: 14px; opacity: 0.9; }
        .attendance-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .attendance-table th { background: #667eea; color: white; padding: 12px; text-align: left; font-weight: 600; }
        .attendance-table td { padding: 10px 12px; border-bottom: 1px solid #eee; }
        .attendance-table tr:hover { background: #f8f9fa; }
        .status-badge { display: inline-flex; align-items: center; gap: 5px; padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; }
        .status-badge.present { background: #d4fc79; color: #27ae60; }
        .status-badge.late { background: #ffeaa7; color: #f39c12; }
        .status-badge.absent { background: #ff7675; color: white; }
        .status-badge.excused { background: #74b9ff; color: white; }
        .empty-state { background: white; border-radius: 15px; text-align: center; padding: 60px 20px; color: #999; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .empty-state i { font-size: 64px; margin-bottom: 20px; opacity: 0.3; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-btn" onclick="window.location.href='parent-dashboard.html'">
                <i class="fas fa-arrow-left"></i> Geri
            </button>
            <h1><i class="fas fa-calendar-check"></i> ≈ûagird Davamiyy…ôti</h1>
        </div>

        <div class="loading" id="loadingDiv">
            <i class="fas fa-spinner fa-spin"></i> Davamiyy…ôt y√ºkl…ônir...
        </div>

        <div id="attendanceContent" style="display: none;">
            <div class="attendance-card">
                <div class="progress-container">
                    <div class="progress-label">
                        <span>ƒ∞≈ütirak Faizi</span>
                        <span id="attendancePercentage">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card present">
                        <div class="stat-number" id="presentCount">0</div>
                        <div class="stat-label">‚úì D…ôrsd…ô</div>
                    </div>
                    <div class="stat-card late">
                        <div class="stat-number" id="lateCount">0</div>
                        <div class="stat-label">‚è∞ Gecikdi</div>
                    </div>
                    <div class="stat-card absent">
                        <div class="stat-number" id="absentCount">0</div>
                        <div class="stat-label">‚úó G…ôlm…ôdi</div>
                    </div>
                    <div class="stat-card excused">
                        <div class="stat-number" id="excusedCount">0</div>
                        <div class="stat-label">üìÑ √úzrl√º</div>
                    </div>
                </div>

                <h3 style="margin-bottom: 15px; color: #333;">
                    <i class="fas fa-list"></i> Davamiyy…ôt Qeydl…ôri
                </h3>
                <table class="attendance-table">
                    <thead>
                        <tr>
                            <th>Tarix</th>
                            <th>Qrup</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="empty-state" id="emptyState" style="display: none;">
            <i class="fas fa-clipboard-list"></i>
            <p style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Davamiyy…ôt qeydi yoxdur</p>
            <p>Bu ≈üagird √º√ß√ºn h…ôl…ô davamiyy…ôt qeyd…ô alƒ±nmayƒ±b</p>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDE05ufg0FhPIAecIJ_ehr9yIFQKxIwncA",
            authDomain: "bekrinschool.firebaseapp.com",
            projectId: "bekrinschool",
            storageBucket: "bekrinschool.firebasestorage.app",
            messagingSenderId: "678081137706",
            appId: "1:678081137706:web:75601b998dde21f25f0753"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const urlParams = new URLSearchParams(window.location.search);
        const studentEmail = urlParams.get('student');

        if (!studentEmail) {
            alert('≈ûagird m…ôlumatƒ± tapƒ±lmadƒ±!');
            window.location.href = 'parent-dashboard.html';
        }

        async function loadStudentAttendance() {
            try {
                console.log('üìä ≈ûagird davamiyy…ôti y√ºkl…ônir:', studentEmail);

                const groupsSnapshot = await db.collection('groups')
                    .where('students', 'array-contains', studentEmail)
                    .where('active', '==', true)
                    .get();

                if (groupsSnapshot.empty) {
                    showEmptyState();
                    return;
                }

                let totalRecords = 0;
                let presentCount = 0;
                let lateCount = 0;
                let absentCount = 0;
                let excusedCount = 0;
                const allRecords = [];

                for (const groupDoc of groupsSnapshot.docs) {
                    const groupData = groupDoc.data();
                    const groupId = groupDoc.id;

                    const attendanceDoc = await db.collection('attendance').doc(groupId).get();
                    if (attendanceDoc.exists) {
                        const attendanceData = attendanceDoc.data();
                        const months = attendanceData.months || [];
                        
                        // ‚úÖ D√úZ∆èLƒ∞≈û: ROOT-dan data oxu (≈üagird kimi)
                        const data = attendanceData.data || {};
                        const studentData = data[studentEmail] || {};
                        
                        console.log('üìã Student data keys:', Object.keys(studentData));

                        // Process each month
                        months.forEach((month, monthIndex) => {
                            month.columns.forEach((column, columnIndex) => {
                                const key = `${monthIndex}_${columnIndex}`;
                                const status = studentData[key];

                                if (status && column.date) {
                                    totalRecords++;
                                    if (status === 'present') presentCount++;
                                    else if (status === 'late') lateCount++;
                                    else if (status === 'absent') absentCount++;
                                    else if (status === 'excused') excusedCount++;

                                    allRecords.push({
                                        date: column.timestamp,
                                        groupName: groupData.groupName || groupData.name || 'Qrup',
                                        status: status
                                    });
                                }
                            });
                        });
                    }
                }

                console.log('‚úÖ √úmumi qeydl…ôr:', totalRecords);

                if (totalRecords === 0) {
                    showEmptyState();
                    return;
                }

                allRecords.sort((a, b) => b.date - a.date);

                const attended = presentCount + lateCount + excusedCount;
                const percentage = Math.round((attended / totalRecords) * 100);

                displayAttendanceData({
                    percentage,
                    presentCount,
                    lateCount,
                    absentCount,
                    excusedCount,
                    records: allRecords
                });

            } catch (error) {
                console.error('X…ôta:', error);
                document.getElementById('loadingDiv').innerHTML = '<div style="background: white; padding: 30px; border-radius: 15px; color: #ff4757;"><i class="fas fa-exclamation-circle"></i> Davamiyy…ôt y√ºkl…ôn…ôrk…ôn x…ôta ba≈ü verdi!</div>';
            }
        }


        function displayAttendanceData(data) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('attendanceContent').style.display = 'block';

            document.getElementById('attendancePercentage').textContent = data.percentage + '%';
            document.getElementById('progressFill').style.width = data.percentage + '%';
            document.getElementById('progressFill').textContent = data.percentage + '%';

            document.getElementById('presentCount').textContent = data.presentCount;
            document.getElementById('lateCount').textContent = data.lateCount;
            document.getElementById('absentCount').textContent = data.absentCount;
            document.getElementById('excusedCount').textContent = data.excusedCount;

            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = data.records.map(record => {
                const date = new Date(record.date);
                const formattedDate = date.toLocaleDateString('az-AZ', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });

                const statusMap = {
                    'present': { text: 'D…ôrsd…ô', icon: '‚úì', class: 'present' },
                    'late': { text: 'Gecikdi', icon: '‚è∞', class: 'late' },
                    'absent': { text: 'G…ôlm…ôdi', icon: '‚úó', class: 'absent' },
                    'excused': { text: '√úzrl√º', icon: 'üìÑ', class: 'excused' }
                };

                const status = statusMap[record.status] || { text: record.status, icon: '', class: '' };

                return `
                    <tr>
                        <td>${formattedDate}</td>
                        <td>${record.groupName}</td>
                        <td>
                            <span class="status-badge ${status.class}">
                                ${status.icon} ${status.text}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showEmptyState() {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }

        window.addEventListener('load', loadStudentAttendance);
    </script>
</body>
</html>
